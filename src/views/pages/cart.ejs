<%- include('../partials/header') %>

  <div class="p-6">
    <h1 class="text-3xl font-bold mb-6">Koszyk</h1>

    <% if (cart.length===0) { %>
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400 text-xl mb-4">Twój koszyk jest pusty</p>
        <a href="/products" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
          Przejdź do sklepu
        </a>
      </div>
      <% } else { %>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <% cart.forEach(item=> { %>
              <div class="flex gap-4 p-4 mb-4 border rounded dark:border-gray-700 bg-white dark:bg-gray-800">
                <% if (item.image) { %>
                  <img src="<%= item.image %>" alt="<%= item.name %>" class="w-24 h-24 object-cover rounded">
                  <% } %>

                    <div class="flex-1">
                      <h3 class="text-xl font-semibold mb-2">
                        <%= item.name %>
                      </h3>
                      <p class="text-green-600 dark:text-green-400 font-bold text-lg">$<%= item.price %>
                      </p>

                      <div class="flex items-center gap-4 mt-4">
                        <label class="text-sm">Ilość:</label>
                        <input type="number" min="1" value="<%= item.quantity %>"
                          class="w-20 px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600"
                          data-product-id="<%= item.productId %>" onchange="updateQuantity(this)">

                        <form method="POST" action="/cart/remove/<%= item.productId %>" class="inline">
                          <button type="submit" class="text-red-600 hover:text-red-800 dark:text-red-400 text-sm">
                            Usuń
                          </button>
                        </form>
                      </div>
                    </div>

                    <div class="text-right">
                      <p class="text-xl font-bold">$<%= (item.price * item.quantity).toFixed(2) %>
                      </p>
                    </div>
              </div>
              <% }) %>
          </div>

          <div class="lg:col-span-1">
            <div class="border p-6 rounded dark:border-gray-700 bg-white dark:bg-gray-800 sticky top-6">
              <h2 class="text-2xl font-bold mb-4">Podsumowanie</h2>

              <div class="border-t border-b py-4 mb-4 dark:border-gray-700">
                <div class="flex justify-between mb-2">
                  <span>Produkty (<%= cart.reduce((sum, item)=> sum + item.quantity, 0) %>):</span>
                  <span>$<%= total.toFixed(2) %></span>
                </div>
                <div class="flex justify-between font-bold text-lg">
                  <span>Suma:</span>
                  <span class="text-green-600 dark:text-green-400">$<%= total.toFixed(2) %></span>
                </div>
              </div>

              <a href="/checkout"
                class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded text-center mb-2">
                Przejdź do kasy
              </a>

              <form method="POST" action="/cart/clear">
                <button type="submit"
                  class="w-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 font-bold py-2 px-4 rounded">
                  Wyczyść koszyk
                </button>
              </form>
            </div>
          </div>
        </div>
        <% } %>
  </div>

  <script>
    const updateQuantity = async (input) => {
      const { productId } = input.dataset;
      const quantity = parseInt(input.value);

      try {
        const response = await fetch(`/cart/update/${productId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });

        const data = await response.json();
        if (data.success) location.reload();
      } catch (error) {
        console.error('Błąd aktualizacji:', error);
      }
    };
  </script>

  <%- include('../partials/footer') %>